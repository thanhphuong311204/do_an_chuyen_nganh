<div th:fragment="content">

    <!-- ===================================================== -->
    <!-- üîπ PH·∫¶N 1: SLIDE-IN PANEL HI·ªÇN TH·ªä CHI TI·∫æT NG∆Ø·ªúI D√ôNG -->
    <!-- ===================================================== -->
    <div id="userDetailPanel"
        class="fixed top-0 right-0 w-96 bg-white h-full shadow-lg transform translate-x-full transition-transform duration-300 z-[9999]">

        <div class="p-6 border-b flex justify-between items-center">
            <h2 class="text-xl font-semibold">Chi ti·∫øt ng∆∞·ªùi d√πng</h2>
            <button onclick="closeDetail()" class="text-gray-500 hover:text-gray-800">‚úñ</button>
        </div>

        <div id="detailContent" class="p-6 space-y-3 text-gray-700">
            <!-- N·ªôi dung chi ti·∫øt ng∆∞·ªùi d√πng s·∫Ω ƒë∆∞·ª£c load v√†o ƒë√¢y -->
        </div>
    </div>


    <!-- ===================================================== -->
    <!-- üîπ PH·∫¶N 2: MODAL FORM TH√äM NG∆Ø·ªúI D√ôNG M·ªöI (·∫®N M·∫∂C ƒê·ªäNH) -->
    <!-- ===================================================== -->
    <div id="addUserModal"
        class="fixed inset-0 bg-black bg-opacity-30 flex items-center justify-center hidden z-[99999]">
        <div class="bg-white rounded-lg p-6 w-96 shadow-lg">
            <h3 class="text-xl font-semibold mb-4">Th√™m ng∆∞·ªùi d√πng m·ªõi</h3>

            <!-- √î nh·∫≠p th√¥ng tin -->
            <div class="space-y-3">
                <input id="newUserName" type="text" placeholder="T√™n ƒëƒÉng nh·∫≠p"
                    class="w-full border px-3 py-2 rounded" />
                <input id="newEmail" type="email" placeholder="Email" class="w-full border px-3 py-2 rounded" />
                <input id="newPhone" type="text" placeholder="S·ªë ƒëi·ªán tho·∫°i" class="w-full border px-3 py-2 rounded" />
                <input id="newName" type="text" placeholder="H·ªç t√™n" class="w-full border px-3 py-2 rounded" />
                <input type="password" placeholder="M·∫≠t kh·∫©u" name="password" class="w-full border px-3 py-2 rounded" />

            </div>

            <!-- N√∫t h√†nh ƒë·ªông -->
            <div class="flex justify-end gap-2 mt-4">
                <button onclick="closeAddUserForm()" class="px-3 py-1 bg-gray-200 rounded">H·ªßy</button>
                <button onclick="saveUser()" class="px-3 py-1 bg-blue-600 text-white rounded">L∆∞u</button>
            </div>
        </div>
    </div>


    <!-- ===================================================== -->
    <!-- üîπ PH·∫¶N 3: TI√äU ƒê·ªÄ + N√öT TH√äM NG∆Ø·ªúI D√ôNG -->
    <!-- ===================================================== -->
    <div class="flex justify-between items-center mb-6">
        <h1 class="text-3xl font-semibold text-gray-900">Qu·∫£n l√Ω ng∆∞·ªùi d√πng</h1>

        <!-- N√∫t th√™m ng∆∞·ªùi d√πng n·∫±m ·ªü g√≥c ph·∫£i -->
        <button onclick="openAddUserForm()" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">
            + Th√™m ng∆∞·ªùi d√πng
        </button>
    </div>


    <!-- ===================================================== -->
    <!-- üîπ PH·∫¶N 4: B·∫¢NG DANH S√ÅCH NG∆Ø·ªúI D√ôNG -->
    <!-- ===================================================== -->
    <div class="bg-white p-6 rounded-xl shadow">
        <table class="w-full text-left">
            <thead>
                <tr class="text-gray-600 border-b">
                    <th class="py-3">ID</th>
                    <th class="py-3">Email</th>
                    <th class="py-3">Tr·∫°ng th√°i</th>
                    <th class="py-3">H√†nh ƒë·ªông</th>
                </tr>
            </thead>
            <tbody id="userTableBody"></tbody>
        </table>
    </div>

    <!-- ===================================================== -->
    <!-- üîπ PH·∫¶N 5: SCRIPT X·ª¨ L√ù LOGIC -->
    <!-- ===================================================== -->
    <script>
        // T·∫£i danh s√°ch ng∆∞·ªùi d√πng khi load trang
        loadUsers();

        // ------------------------------
        // üß© H√ÄM 1: Load danh s√°ch ng∆∞·ªùi d√πng
        // ------------------------------
        function loadUsers() {
            fetch("/api/admin/users")
                .then(res => res.json())
                .then(users => {
                    const tbody = document.getElementById("userTableBody");
                    tbody.innerHTML = "";

                    users.forEach(u => {
                        tbody.innerHTML += `
                            <tr class="border-b">
                                <td class="py-3">${u.id}</td>
                                <td>${u.email}</td>
                                <td>
                                    ${u.active ?
                                '<span class="text-green-600 font-medium">ƒêang ho·∫°t ƒë·ªông</span>' :
                                '<span class="text-red-600 font-medium">ƒê√£ kh√≥a</span>'}
                                </td>
                                <td class="py-3 flex gap-2">

                                    <!-- N√∫t xem -->
                                    <button onclick="openDetail(${u.id})"
                                        class="px-3 py-1 bg-blue-100 text-blue-700 rounded hover:bg-blue-200">
                                        Xem
                                    </button>

                                    <!-- N√∫t kh√≥a / m·ªü kh√≥a -->
                                    ${u.active
                                ? `<button onclick="banUser(${u.id})"
                                            class="px-3 py-1 bg-red-100 text-red-700 rounded hover:bg-red-200">
                                                Kh√≥a
                                           </button>`
                                : `<button onclick="unbanUser(${u.id})"
                                            class="px-3 py-1 bg-green-100 text-green-700 rounded hover:bg-green-200">
                                                M·ªü kh√≥a
                                           </button>`
                            }
                                </td>
                            </tr>
                        `;
                    });
                })
                .catch(err => console.error("L·ªói t·∫£i ng∆∞·ªùi d√πng:", err));
        }

        // ------------------------------
        // üß© H√ÄM 2: Kh√≥a ng∆∞·ªùi d√πng
        // ------------------------------
        function banUser(id) {
            fetch(`/api/admin/users/${id}/ban`, { method: "PUT" })
                .then(() => loadUsers());
        }

        // ------------------------------
        // üß© H√ÄM 3: M·ªü kh√≥a ng∆∞·ªùi d√πng
        // ------------------------------
        function unbanUser(id) {
            fetch(`/api/admin/users/${id}/unban`, { method: "PUT" })
                .then(() => loadUsers());
        }

        // ------------------------------
        // üß© H√ÄM 4: M·ªü panel chi ti·∫øt ng∆∞·ªùi d√πng
        // ------------------------------
        function openDetail(id) {
            const panel = document.getElementById("userDetailPanel");
            panel.classList.remove("translate-x-full");
            const detailContent = document.getElementById("detailContent");
            detailContent.innerHTML = "<p>ƒêang t·∫£i th√¥ng tin ng∆∞·ªùi d√πng...</p>";

            fetch(`/api/admin/users/${id}`)
                .then(res => {
                    if (!res.ok) throw new Error("Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu ng∆∞·ªùi d√πng");
                    return res.json();
                })
                .then(user => {
                    detailContent.innerHTML = `
                        <div class="space-y-2">
                            <p><strong>ID:</strong> ${user.id}</p>
                            <p><strong>Email:</strong> ${user.email}</p>
                            <p><strong>S·ªë ƒëi·ªán tho·∫°i:</strong> ${user.phone ?? 'Ch∆∞a c√≥'}</p>
                            <p><strong>H·ªç t√™n:</strong> ${user.name ?? 'Ch∆∞a c√≥'}</p>
                            <p><strong>Tr·∫°ng th√°i:</strong> 
                                ${user.active
                            ? '<span class="text-green-600 font-medium">ƒêang ho·∫°t ƒë·ªông</span>'
                            : '<span class="text-red-600 font-medium">ƒê√£ kh√≥a</span>'}
                            </p>
                            <p><strong>Ng√†y t·∫°o:</strong> ${user.createdAt ?? 'Kh√¥ng r√µ'}</p>
                        </div>
                    `;
                })
                .catch(err => {
                    detailContent.innerHTML = `<p class="text-red-600">${err.message}</p>`;
                });
        }

        // ------------------------------
        // üß© H√ÄM 5: ƒê√≥ng panel chi ti·∫øt
        // ------------------------------
        function closeDetail() {
            const panel = document.getElementById("userDetailPanel");
            panel.classList.add("translate-x-full");
        }

        // ------------------------------
        // üß© H√ÄM 6: M·ªü form th√™m ng∆∞·ªùi d√πng m·ªõi
        // ------------------------------
        function openAddUserForm() {
            document.getElementById("addUserModal").classList.remove("hidden");
        }

        // ------------------------------
        // üß© H√ÄM 7: ƒê√≥ng form th√™m ng∆∞·ªùi d√πng
        // ------------------------------
        function closeAddUserForm() {
            document.getElementById("addUserModal").classList.add("hidden");
        }

        // ------------------------------
        // üß© H√ÄM 8: L∆∞u ng∆∞·ªùi d√πng m·ªõi (POST API)
        // ------------------------------
        function saveUser() {
            const userName = document.getElementById("newUserName").value.trim();
            const email = document.getElementById("newEmail").value.trim();
            const phone = document.getElementById("newPhone").value.trim();
            const name = document.getElementById("newName").value.trim();

            if (!userName || !email) {
                alert("Vui l√≤ng nh·∫≠p t√™n ƒëƒÉng nh·∫≠p v√† email!");
                return;
            }

            const data = { userName, email, phone, name };

            fetch("/api/admin/users", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(data)
            })
                .then(async res => {
                    const msg = await res.text();
                    alert(msg);
                    if (res.ok) {
                        closeAddUserForm();
                        loadUsers();
                    }
                })
                .catch(err => alert("L·ªói: " + err));
        }
    </script>

</div>