<div th:fragment="content" class="p-6">

    <!-- üåü Ti√™u ƒë·ªÅ -->
    <div class="flex items-center justify-between mb-6">
        <h1 class="text-3xl font-semibold flex items-center gap-2 text-gray-800">
            <span>üîî</span> Qu·∫£n l√Ω th√¥ng b√°o h·ªá th·ªëng
        </h1>
        <button onclick="openForm()" 
                class="bg-green-600 hover:bg-green-700 text-white px-5 py-2 rounded-lg shadow transition-all duration-200 flex items-center gap-2">
            <span>‚ûï</span> G·ª≠i th√¥ng b√°o
        </button>
    </div>

    <!-- üåø B·∫£ng th√¥ng b√°o -->
    <div class="bg-white shadow-md rounded-xl overflow-hidden border border-gray-200">
        <table class="w-full border-collapse">
            <thead class="bg-gradient-to-r from-gray-100 to-gray-200 text-gray-700 uppercase text-sm tracking-wide">
                <tr>
                    <th class="px-4 py-3 text-left w-16">#</th>
                    <th class="px-4 py-3 text-left">Ti√™u ƒë·ªÅ</th>
                    <th class="px-4 py-3 text-left">N·ªôi dung</th>
                    <th class="px-4 py-3 text-left w-48">Ng√†y t·∫°o</th>
                    <th class="px-4 py-3 text-center w-24">H√†nh ƒë·ªông</th>
                </tr>
            </thead>
            <tbody id="notiTableBody" class="divide-y divide-gray-100 text-gray-800 text-sm">
                <tr>
                    <td colspan="5" class="text-center py-6 text-gray-500">ƒêang t·∫£i...</td>
                </tr>
            </tbody>
        </table>
    </div>

    <!-- üåà Modal t·∫°o th√¥ng b√°o -->
    <div id="notiModal" class="hidden fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50">
        <div class="bg-white rounded-2xl w-[420px] p-6 shadow-2xl transform transition-all scale-95">
            <h2 class="text-xl font-semibold mb-4 text-gray-800 flex items-center gap-2">üìù T·∫°o th√¥ng b√°o m·ªõi</h2>

            <label class="block text-sm text-gray-600 mb-1">Ti√™u ƒë·ªÅ</label>
            <input id="title" type="text" placeholder="Nh·∫≠p ti√™u ƒë·ªÅ..." 
                   class="border w-full p-2 rounded-lg mb-3 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">

            <label class="block text-sm text-gray-600 mb-1">N·ªôi dung</label>
            <textarea id="message" placeholder="Nh·∫≠p n·ªôi dung..." 
                      class="border w-full p-2 rounded-lg h-28 mb-4 resize-none focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"></textarea>

            <div class="flex justify-end gap-2">
                <button onclick="closeForm()" class="bg-gray-200 hover:bg-gray-300 px-4 py-2 rounded-lg transition">H·ªßy</button>
                <button onclick="sendBroadcast()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg shadow transition">
                    G·ª≠i to√†n h·ªá th·ªëng
                </button>
            </div>
        </div>
    </div>

    <!-- üìú JS x·ª≠ l√Ω -->
    <script>
        async function loadNotifications() {
            try {
                const res = await fetch('/api/admin/notifications');
                const data = await res.json();
                const tbody = document.getElementById('notiTableBody');
                tbody.innerHTML = '';

                if (!data || data.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="5" class="text-center py-6 text-gray-500 italic">Ch∆∞a c√≥ th√¥ng b√°o n√†o</td></tr>`;
                    return;
                }

                data.forEach((n, index) => {
                    const date = new Date(n.createdAt);
                    const formattedDate = date.toLocaleTimeString('vi-VN') + '<br>' + date.toLocaleDateString('vi-VN');
                    tbody.innerHTML += `
                        <tr class="hover:bg-gray-50 transition-all">
                            <td class="px-4 py-2 font-medium text-gray-500 text-center">${index + 1}</td>
                            <td class="px-4 py-2 font-semibold text-gray-800">${n.notificationTitle || '(Kh√¥ng c√≥ ti√™u ƒë·ªÅ)'}</td>
                            <td class="px-4 py-2 text-gray-700">${n.notificationMessage || '(Kh√¥ng c√≥ n·ªôi dung)'}</td>
                            <td class="px-4 py-2 text-sm text-gray-600">${formattedDate}</td>
                            <td class="px-4 py-2 text-center">
                                <button onclick="del(${n.notificationId})"
                                        class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded-md text-xs font-medium transition-all">
                                    X√≥a
                                </button>
                            </td>
                        </tr>
                    `;
                });
            } catch (e) {
                console.error('L·ªói khi t·∫£i th√¥ng b√°o:', e);
                document.getElementById('notiTableBody').innerHTML =
                    `<tr><td colspan="5" class="text-center py-6 text-red-500">‚ùå Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu</td></tr>`;
            }
        }

        async function sendBroadcast() {
            const title = document.getElementById('title').value.trim();
            const message = document.getElementById('message').value.trim();

            if (!title || !message) {
                alert('‚ö†Ô∏è Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß ti√™u ƒë·ªÅ v√† n·ªôi dung.');
                return;
            }

            try {
                const res = await fetch('/api/admin/notifications/broadcast', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        notificationTitle: title,
                        notificationMessage: message
                    })
                });

                if (res.ok) {
                    alert('‚úÖ ƒê√£ g·ª≠i th√¥ng b√°o to√†n h·ªá th·ªëng!');
                    closeForm();
                    loadNotifications();
                } else {
                    alert('‚ùå G·ª≠i th√¥ng b√°o th·∫•t b·∫°i.');
                }
            } catch (e) {
                console.error('L·ªói khi g·ª≠i th√¥ng b√°o:', e);
            }
        }

        async function del(id) {
            if (!confirm('üóëÔ∏è B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a th√¥ng b√°o n√†y?')) return;
            try {
                const res = await fetch(`/api/admin/notifications/${id}`, { method: 'DELETE' });
                if (res.ok) {
                    loadNotifications();
                } else {
                    alert('‚ùå X√≥a th·∫•t b·∫°i.');
                }
            } catch (e) {
                console.error('L·ªói khi x√≥a th√¥ng b√°o:', e);
            }
        }

        function openForm() {
            document.getElementById('title').value = '';
            document.getElementById('message').value = '';
            document.getElementById('notiModal').classList.remove('hidden');
        }

        function closeForm() {
            document.getElementById('notiModal').classList.add('hidden');
        }

        document.addEventListener("DOMContentLoaded", loadNotifications);
    </script>
</div>
