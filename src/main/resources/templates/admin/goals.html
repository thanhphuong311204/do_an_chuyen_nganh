<div th:fragment="content">

    <!-- TiÃªu Ä‘á» -->
    <h1 class="text-3xl font-semibold mb-6">ğŸ¯ Quáº£n lÃ½ má»¥c tiÃªu há»‡ thá»‘ng</h1>

    <!-- ========== THá»NG KÃŠ Tá»”NG QUAN ========== -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
        <div class="bg-blue-100 p-5 rounded-lg text-center shadow">
            <h2 class="text-2xl font-bold text-blue-700" th:text="${stats.totalGoals}">0</h2>
            <p class="text-gray-700 mt-1">Tá»•ng sá»‘ má»¥c tiÃªu</p>
        </div>

        <div class="bg-green-100 p-5 rounded-lg text-center shadow">
            <h2 class="text-2xl font-bold text-green-700" th:text="${stats.completedGoals}">0</h2>
            <p class="text-gray-700 mt-1">HoÃ n thÃ nh</p>
        </div>

        <div class="bg-yellow-100 p-5 rounded-lg text-center shadow">
            <h2 class="text-2xl font-bold text-yellow-700" th:text="${stats.completionRate + '%'}">0%</h2>
            <p class="text-gray-700 mt-1">Tá»· lá»‡ hoÃ n thÃ nh</p>
        </div>

        <div class="bg-purple-100 p-5 rounded-lg text-center shadow">
            <h2 class="text-2xl font-bold text-purple-700"
                th:text="${#numbers.formatInteger(stats.totalSaved, 0, 'POINT')} + ' â‚«'">0 â‚«</h2>
            <p class="text-gray-700 mt-1">Tá»•ng tiá»n Ä‘Ã£ Ä‘áº¡t</p>
        </div>
    </div>

    <!-- ========== BIá»‚U Äá»’ Tá»¶ Lá»† HOÃ€N THÃ€NH THEO THÃNG ========== -->
    <div class="bg-white rounded-xl shadow p-6 mb-6">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-lg font-semibold">Tá»· lá»‡ hoÃ n thÃ nh má»¥c tiÃªu theo thÃ¡ng</h2>
            <button onclick="reloadChart()" class="bg-blue-600 text-white px-4 py-1 rounded hover:bg-blue-700 text-sm">
                ğŸ”„ LÃ m má»›i
            </button>
        </div>
        <canvas id="goalChart" height="120"></canvas>
    </div>

    <!-- ========== Báº¢NG Tá»”NG Há»¢P áº¨N DANH ========== -->
    <div class="bg-white rounded-xl shadow p-6">
        <h2 class="text-lg font-semibold mb-4">Máº«u thá»‘ng kÃª áº©n danh</h2>
        <table class="w-full border-collapse text-left">
            <thead class="border-b text-gray-600">
                <tr>
                    <th class="py-2">#</th>
                    <th>TÃªn danh má»¥c</th>
                    <th>Tiá»n má»¥c tiÃªu</th>
                    <th>ÄÃ£ Ä‘áº¡t</th>
                    <th>Tiáº¿n Ä‘á»™</th>
                </tr>
            </thead>
            <tbody id="sampleGoalBody" class="text-gray-700">
                <!-- Dá»¯ liá»‡u máº«u (áº©n danh) -->
            </tbody>
        </table>
    </div>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        let chartInstance;

        // ğŸ“Š Load dá»¯ liá»‡u biá»ƒu Ä‘á»“ tá»« API tháº­t
        async function loadGoalStats() {
            try {
                const res = await fetch('/api/admin/goals/stats-by-month');
                const data = await res.json();

                const labels = data.map(d => 'ThÃ¡ng ' + d.month);
                const completed = data.map(d => d.completedGoals);
                const total = data.map(d => d.totalGoals);

                const rates = total.map((t, i) => t > 0 ? (completed[i] / t * 100).toFixed(1) : 0);

                const ctx = document.getElementById('goalChart').getContext('2d');
                if (chartInstance) chartInstance.destroy();

                chartInstance = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Tá»· lá»‡ hoÃ n thÃ nh (%)',
                            data: rates,
                            backgroundColor: '#4F46E5'
                        }]
                    },
                    options: {
                        scales: {
                            y: { beginAtZero: true, max: 100, title: { display: true, text: 'Pháº§n trÄƒm (%)' } }
                        },
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    label: ctx => ctx.parsed.y + '% hoÃ n thÃ nh'
                                }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error("Lá»—i táº£i biá»ƒu Ä‘á»“:", error);
            }
        }

        // ğŸ” LÃ m má»›i biá»ƒu Ä‘á»“
        function reloadChart() {
            loadGoalStats();
        }

        // ğŸ“‹ Load báº£ng thá»‘ng kÃª tháº­t tá»« DB (áº©n danh)
        async function loadSampleTable() {
            const tbody = document.getElementById('sampleGoalBody');
            tbody.innerHTML = `<tr><td colspan="5" class="text-center text-gray-500 py-3">Äang táº£i dá»¯ liá»‡u...</td></tr>`;

            try {
                const res = await fetch('/api/admin/goals/list');
                const data = await res.json();

                if (data.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="5" class="text-center text-gray-500 py-3">KhÃ´ng cÃ³ má»¥c tiÃªu nÃ o</td></tr>`;
                    return;
                }

                tbody.innerHTML = data.map((g, i) => `
                <tr class="border-b hover:bg-gray-50">
                    <td class="py-2 px-3">${i + 1}</td>
                    <td class="py-2 px-3">${g.name}</td>
                    <td class="py-2 px-3">${Number(g.target).toLocaleString('vi-VN')} â‚«</td>
                    <td class="py-2 px-3">${Number(g.current).toLocaleString('vi-VN')} â‚«</td>
                    <td class="py-2 px-3">
                        <span class="${g.progress >= 100 ? 'text-green-600' :
                        g.progress >= 70 ? 'text-yellow-600' :
                            'text-gray-600'
                    } font-semibold">${g.progress}%</span>
                    </td>
                </tr>
            `).join('');
            } catch (error) {
                console.error("Lá»—i táº£i báº£ng:", error);
                tbody.innerHTML = `<tr><td colspan="5" class="text-center text-red-500 py-3">Lá»—i táº£i dá»¯ liá»‡u</td></tr>`;
            }
        }

        // Khi trang load xong
        document.addEventListener("DOMContentLoaded", () => {
            loadGoalStats();
            loadSampleTable();
        });
    </script>
</div>